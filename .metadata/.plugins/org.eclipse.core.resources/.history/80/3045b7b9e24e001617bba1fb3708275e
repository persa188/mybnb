package db;

import java.sql.*;

public class Intializer {

	private static final String dbClassName = "com.mysql.jdbc.Driver";
	private static final String CONNECTION = "jdbc:mysql://127.0.0.1/mydb?useSSL=false";
	
	public static void main(String[] args) throws ClassNotFoundException {
		//Register JDBC driver
		Class.forName(dbClassName);
		//Database credentials
		final String USER = "root";
		final String PASS = "1234"; //change this to "", mysql windows req pass=1234
		System.out.println("Connecting to database...");
		
		try {
			//Establish connection
			Connection conn = DriverManager.getConnection(CONNECTION,USER,PASS);
			System.out.println("Successfully connected to MySQL!");
			
			//Execute a query
			System.out.println("Preparing a statement...");
			Statement stmt = conn.createStatement();
			String sql = "CREATE database `mybnb`;";
			sql += "CREATE TABLE `mybnb`.`renter` (";
			sql +=	"`ID` INT NOT NULL,";
			sql	+=	"`fname` VARCHAR(45) NOT NULL,";
			sql +=	"`lname` VARCHAR(45) NOT NULL,";
			sql +=	"`addr` VARCHAR(200) NOT NULL,";
			sql +=	"`dob` VARCHAR(10) NOT NULL,";
			sql +=	"`occupation` VARCHAR(45) NOT NULL,";
			sql +=	"`sin` VARCHAR(45) NOT NULL,";
			sql +=	"`age` INT NOT NULL,";
			sql +=	"PRIMARY KEY (`ID`))";
			sql +=	"USE `mybnb`";

			sql+= "DELIMITER $$";

		    sql += "DROP TRIGGER IF EXISTS mybnb.renter_BEFORE_INSERT$$";
            sql += "USE `mybnb`$$";
            sql += "CREATE DEFINER = CURRENT_USER TRIGGER `mybnb`.`renter_BEFORE_INSERT` BEFORE INSERT ON `renter` FOR EACH ROW";
            sql += "BEGIN";
            sql += "DECLARE msg varchar(255);";
            sql += "IF NEW.age < 1 OR NEW.age < 18 THEN";
            sql += "SET msg = \"Specified Age is too low!\";";
            sql += "SIGNAL sqlstate '45001' set message_text = msg;";
            sql += "END IF;";
            sql += "END$$";
            sql += "DELIMITER;";
			stmt.execute(sql);
			
			//cloes connection, stmt & exit
			System.out.println("Closing connection...");
			stmt.close();
			conn.close();
			System.out.println("Success!");
		} catch (SQLException e) {
			System.err.println(e); //for better error msgs
			System.err.println("Connection error occured!");
		}
	}

}